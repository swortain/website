<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>剑山的个人网站 - insar-socket | 装置插座</title>


    

<link rel="stylesheet" type="text/css" href="http://swortain.wang/css/bootstrap.min.css">

<link rel="stylesheet" type="text/css" href="http://swortain.wang/fonts/line-icons.css">

<link rel="stylesheet" type="text/css" href="http://swortain.wang/css/slicknav.css">




<link rel="stylesheet" type="text/css" href="http://swortain.wang/css/animate.css">

<link rel="stylesheet" type="text/css" href="http://swortain.wang/css/owl.carousel.css">

<link rel="stylesheet" type="text/css" href="http://swortain.wang/css/main.css">

<link rel="stylesheet" type="text/css" href="http://swortain.wang/css/responsive.css">

    <link rel="stylesheet" type="text/css" href="http://swortain.wang/css/nivo-lightbox.css">

</head>

<body>

    <header id="header-wrap">

        

<nav class="navbar navbar-expand-lg fixed-top  scrolling-navbar">



  
  <div class="container">

    

    <div class="navbar-header ">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar"
        aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
      </button>
      <a href="/" class="navbar-brand"><img src="http://swortain.wang/img/logo.png" alt=""></a>
    </div>

    <div class="collapse navbar-collapse row" id="main-navbar">
      <div class="col-md-9">
        <ul class="navbar-nav mr-auto ">
          
          <li class="nav-item " style="flex: auto;">
            <a class="nav-link " href="/" style="text-align: center;">
              Home|主页
            </a>
          </li>
          
          <li class="nav-item " style="flex: auto;">
            <a class="nav-link " href="/project/" style="text-align: center;">
              project|项目
            </a>
          </li>
          
          <li class="nav-item " style="flex: auto;">
            <a class="nav-link " href="/portfolio/" style="text-align: center;">
              portfolio|作品集
            </a>
          </li>
          
          <li class="nav-item " style="flex: auto;">
            <a class="nav-link " href="/blog/" style="text-align: center;">
              blog|博客
            </a>
          </li>
          
        </ul>
      </div>

      <div class="input-group col-md-3 ">
        <input type="search" class="form-control" autocomplete="off" name="s" placeholder="Search..." id="search-input"
          value="" style="background-color: transparent;">
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" id="search-btn"><i class="lni-search"></i></button>
        </div>

      </div>


    </div>

  </div>


  
  <ul class="mobile-menu">

    

    <li class="nav-item ">

      <a class="nav-link " href="/">
        Home|主页
      </a>
    </li>

    

    <li class="nav-item ">

      <a class="nav-link " href="/project/">
        project|项目
      </a>
    </li>

    

    <li class="nav-item ">

      <a class="nav-link " href="/portfolio/">
        portfolio|作品集
      </a>
    </li>

    

    <li class="nav-item ">

      <a class="nav-link " href="/blog/">
        blog|博客
      </a>
    </li>

    

    <div class="input-group col-md-12 " style="padding-bottom: 1.0em">
      <input type="search" class="form-control" autocomplete="off" name="s" placeholder="Search..." id="search-input"
        value="" style="background-color: transparent;">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" type="button" id="search-btn"><i class="lni-search"></i></button>
      </div>

    </div>

  </ul>
  

</nav>


    </header>

    

    <div class="page-header" style="background: url(/project/insar-socket/head.jpg); background-size: cover;background-position: center">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="breadcrumb-wrapper">
                        <h2 class="product-title">insar-socket | 装置插座</h2>
                        <ol class="breadcrumb">
                            <li class="current"> Home/project/insar-socket/ </li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="content" class="section-padding">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-xs-12">

                <div class="blog-post single-post">



                    <div class="post-thumb">

                       
                        <div class="hover-wrap">
                        </div>
                    </div>


                    <div class="post-content">
                        <h2 class="post-title">insar-socket | 装置插座</h2>
                        <div class="meta">
                            <span class="meta-part"><i class="lni-user"></i> 剑山 </span>
                            <span class="meta-part"></i>  May 26,
                                2021 </span>

                            
                        </div>
                        <div class="entry-summary">
                            <p> </p>
<p>insar-socket是我的第一个产品类的作品，主要的功能是支持Modbus-TCP的插座，可以让你在装置项目中集成一个220的电器，而不需要你懂任何的电子电路知识。
我还写了一写装置软件的库（目前位置仅支持了TouchDesigner）。这样你甚至不需要了解Modbus的相关知识，只需要配网，和软件内部的一些设置即可。</p>
<p> </p>
<p> </p>
<p> </p>
<h1 id="参数">参数</h1>
<p>功率：额定功率2000w，长期负载建议不找过1500w。</p>
<p>电压：由于接口采用国标规范，所以无法在国外使用，但是设计上采用100~240V，支持全球通用。</p>
<hr>
<h1 id="pcb效果图">PCB效果图</h1>
<div style="text-align: center;"><img src="210408_insar_socket_wifi_v1.0_2021-May-24_12-47-55PM-000_CustomizedView17431953528.png"     style="width:100%"    ></div>
<div style="text-align: center;"><img src="210408_insar_socket_wifi_v1.0_2021-May-24_12-48-13PM-000_CustomizedView12947416057.png"     style="width:100%"    ></div>
<div style="text-align: center;"><img src="210408_insar_socket_wifi_v1.0_2021-May-24_12-48-39PM-000_CustomizedView24995213232.png"     style="width:100%"    ></div>
<p> 
 
 </p>
<hr>
<h1 id="使用教程">使用教程</h1>
<h2 id="配网">配网</h2>
<p>设备第一次链接WiFi时需要进行配网操作，让设备知道需要链接的WiFi的SSID和密码。这个操作如果不更换链接WiFi的名称和密码的情况下，只需要做一次，后面设备每次开机会自动连接最近一次设置的WiFi。</p>
<p>先给设备供电，按钮处红色LED常亮，并且黄色LED缓慢闪烁，此时可以搜索到一个「insar_config_」开头的wifi热点。</p>
<div style="text-align: center;"><img src="Screenshot_2021-05-25-17-42-39-350_com.android.settings.jpg"     style="width:40%"    ></div>
<p>连接后会自动弹出一个页面（在iphone上通常会自动弹出）或者显示需登录/认证（在我的小米手机上是这样的）点击后弹出页面</p>
<div style="text-align: center;"><img src="Screenshot_2021-05-25-17-42-42-833_com.android.htmlviewer.jpg"     style="width:40%"    ></div>
<p>点击Configure WiFi</p>
<div style="text-align: center;"><img src="Screenshot_2021-05-25-17-43-37-072_com.android.htmlviewer.jpg"     style="width:40%"    ></div>
<p>点击要连接的WiFi名称，在密码行填入密码</p>
<div style="text-align: center;"><img src="Screenshot_2021-05-25-17-43-47-722_com.android.htmlviewer.jpg"     style="width:40%"    ></div>
<p>点击save后设备后自动重启后链接wifi。黄色LED闪烁几次后常亮，表示已经成功连上WiFi</p>
<h2 id="touchdesigner库">TouchDesigner库</h2>
<p>首先电脑要和设备连入同一个wifi。打开insar-socket.toe这个文件，在insar_socket OP的参数里有一个search点击旁边的pulse会自动搜索局域网内所有的设备。</p>
<div style="text-align: center;"><img src="1621935987%281%29.png"     style="width:100%"    ></div>
<p>搜索完成后会弹出一个窗口，点击ok后IP Address会列出所有局域网内所有的设备的IP地址。</p>
<div style="text-align: center;"><img src="1621936092%281%29.jpg"     style="width:100%"    ></div>
<p>在左边连入一个CHOP，当里面任意一个channel从0变为非零的时候会打开插座，反之会关闭插座</p>
<p> </p>
<h2 id="后台管理界面">后台管理界面</h2>
<p>在浏览器输入设备的IP地址，可以看到后台的管理界面，可以看到设备ID，固件版本，插座的通断以及可以控制插座的打开和关闭。</p>
<div style="text-align: center;"><img src="1621936175%281%29.jpg"     style="width:100%"    ></div>
<hr>
<h1 id="基于其他平台实现二次开发">基于其他平台实现二次开发</h1>
<p>如果你只是想在已有库的软件（比如目前的Touchdesigner）里面使用本设备的话，这一部分是不需要看的，如果你需要集成到其他的环境中，比如单片机（需要设备能联网，比如使用ESP32、ESP8266或者Arduino UNO加Ethernet shield或者STM32加W5100这些）、openFrameworks、Processing（相关库在计划当中）、或者更底层的比如java、python，那么你需要看下面这部分，同时你需要懂一些TCP/IP通讯相关的知识以及Modbus相关的一些概念。</p>
<h2 id="modbus-通讯协议">Modbus 通讯协议</h2>
<p>设备是基于Mocbus-RTU TCP协议的，也就是说是基于二进制表示数据的方式，所以你需要知道一些指令的含义，关于Modbus-RTU的一些知识可以看我在<a href="https://www.jianshu.com/p/198c1d4db0e5">简书的这里</a>写一些简单的介绍。设备是作为TCP主机的，所以你需要用TCP客户端去连接</p>
<p> </p>
<blockquote class="blockquote"><p>Modbus RTU是一种紧凑的，采用二进制表示数据的方式，Modbus ASCII是一种人类可读的，冗长的表示方式。</p>
<footer class="blockquote-footer">维基百科 </footer>
</blockquote>
<h2 id="参数-1">参数</h2>
<ol>
<li>从机地址：01</li>
<li>端口号：29779（这里不是默认的Modbus TCP端口，是为了方式搜索设备的时候搜索到网络中其他的Modbus设备）</li>
<li>继电器对应的线圈编号：100</li>
<li>校验：modbus标准的CRC16校验</li>
</ol>
<h2 id="控制例程">控制例程</h2>
<p>以下数字均为十六进制</p>
<h3 id="控制线圈">控制线圈</h3>
<table class="table">
<thead>
<tr>
<th style="text-align:center">事务处理标识符</th>
<th style="text-align:center">协议标识符</th>
<th style="text-align:center">长度</th>
<th style="text-align:center">从机地址</th>
<th style="text-align:center">功能码</th>
<th style="text-align:center">线圈编号</th>
<th style="text-align:center">数据</th>
<th style="text-align:center">CRC校验码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">00 00</td>
<td style="text-align:center">00 00</td>
<td style="text-align:center">00 08</td>
<td style="text-align:center">01</td>
<td style="text-align:center">05</td>
<td style="text-align:center">00 64</td>
<td style="text-align:center">FF' 00</td>
<td style="text-align:center">CD E5</td>
</tr>
</tbody>
</table>
<p>数据位如果要打开继电器应为FF 00，如果关闭则是00 00</p>
<p>返回数据与发送的是完全相同的</p>
<h3 id="查询线圈状态">查询线圈状态</h3>
<h4 id="发送">发送</h4>
<table class="table">
<thead>
<tr>
<th style="text-align:center">事务处理标识符</th>
<th style="text-align:center">协议标识符</th>
<th style="text-align:center">长度</th>
<th style="text-align:center">从机地址</th>
<th style="text-align:center">功能码</th>
<th style="text-align:center">线圈编号</th>
<th style="text-align:center">数据</th>
<th style="text-align:center">CRC校验码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">00 00</td>
<td style="text-align:center">00 00</td>
<td style="text-align:center">00 08</td>
<td style="text-align:center">01</td>
<td style="text-align:center">01</td>
<td style="text-align:center">00 64</td>
<td style="text-align:center">00 01</td>
<td style="text-align:center">BC 15</td>
</tr>
</tbody>
</table>
<p>其中事务处理标识符理论上可以是任意数字</p>
<p>协议标识符Modbus都是00 00</p>
<p>线圈编号开始线圈的编号，是100的十六进制，小端模式</p>
<p>数据00 01表示读取一个线圈</p>
<p>注意因为设备内只定义了100号线圈，所以查询其他编号比如99开头的两个线圈或者100开头的2个线圈都会返回错误信息。</p>
<h4 id="返回">返回</h4>
<table class="table">
<thead>
<tr>
<th style="text-align:center">事务处理标识符</th>
<th style="text-align:center">协议标识符</th>
<th style="text-align:center">长度</th>
<th style="text-align:center">从机地址</th>
<th style="text-align:center">功能码</th>
<th style="text-align:center">后面bytes的数量</th>
<th style="text-align:center">状态值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">00 00</td>
<td style="text-align:center">00 00</td>
<td style="text-align:center">00 04</td>
<td style="text-align:center">01</td>
<td style="text-align:center">01</td>
<td style="text-align:center">01</td>
<td style="text-align:center">01</td>
</tr>
</tbody>
</table>
<p>状态值当继电器打开时是01，关闭时是00</p>
<h2 id="crc16校验示例代码python">CRC16校验示例代码（Python）</h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">crc16</span>(data):
	crc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFFF</span>
	<span style="color:#66d9ef">for</span> pos <span style="color:#f92672">in</span> data:
		crc <span style="color:#f92672">^=</span> pos
		<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>):
			<span style="color:#66d9ef">if</span> ((crc <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>):
				crc <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>
				crc <span style="color:#f92672">^=</span> <span style="color:#ae81ff">0xA001</span>
			<span style="color:#66d9ef">else</span>:
				crc <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">return</span> crc<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">2</span>,byteorder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;little&#39;</span>,signed<span style="color:#f92672">=</span>False)</code></pre></td></tr></table>
</div>
</div>
<hr>
<h1 id="硬件的二次开发">硬件的二次开发</h1>
<p>设备出厂预制程序，如果只需要使用的话这一部分是不需要看的，如果想基于现有硬件二次开发，那么你需要了解ESP32的相关知识。</p>
<p>设备是由ESP32开发的，预留了烧写接口如下图，排针是不焊接的，可以使用间距2.54mm的顶针烧写，或者焊接普通2.54mm间距的排针。内部预留了空间保证焊接后也可以装上外壳，</p>
<div style="text-align: center;"><img src="1622310986%281%29.png"     style="width:40%"    ></div>
<h2 id="烧写接口引脚定义">烧写接口引脚定义</h2>
<table>
<thead>
<tr>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
</tr>
</thead>
<tbody>
<tr>
<td>GND</td>
<td>IO0</td>
<td>RST</td>
<td>RXD</td>
<td>TXD</td>
<td>3.3V</td>
</tr>
</tbody>
</table>
<h2 id="烧写过程">烧写过程</h2>
<p>因为设备供电的时候PCB上是有220v强电的，所以建议用烧写器给设备供电3.3v，如果烧写器有ESP32的自动复位电路的话需要链接2、3号引脚，否则只需连接其他四个引脚，但是在上电前需要短接2号和GND引脚使设备进入烧写模式。</p>
<h2 id="引脚定义">引脚定义</h2>
<p>设备内有两个LED，红色是电源LED无法控制，黄色连接了IO21，可以控制。继电器连接是的IO12引脚</p>

                        </div>
                        
                    </div>

                </div>


                <div id="comments">
                    
                    


<section class="comments">
<script src="https://utteranc.es/client.js"
        repo="swortain/website"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</section>

                        
                    </div> 

                </div>

                

                
            </div>
        </div>
    </div>


    
<footer>

    <section class="footer-Content">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6 offset-md-2 offset-lg-2 offset-sm-2">
                    <div class="widget">
                        <h3 class="block-title">联系方式</h3>
                        <ul class="contact-footer">
                            <li>
                                <strong>邮箱 :</strong><span><a href="mailto:jianshan_54@126.com">jianshan_54@126.com</a></span>
                            </li>
                            <li>
                                <strong>简书 :</strong><span><a href="http://www.jianshu.com/u/45d8f935d361">www.jianshu.com/u/45d8f935d361</a></span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-4 ">
                    <div class="widget">
                        <h3 class="block-title">社交媒体</h3>
                        <ul class="footer-social">
                            <li><a class="facebook" href="https://www.facebook.com/profile.php?id=100009586127081"><i
                                        class="lni-facebook-filled"></i></a></li>
                            <li><a class="linkedin" href="https://www.linkedin.com/in/jianwei-wang-a287ab7a/"><i
                                        class="lni-linkedin-fill"></i></a></li>

                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>



</footer>


    <a href="#" class="back-to-top">
        <i class="lni-chevron-up"></i>
    </a>

    

<script src="http://swortain.wang/js/jquery-min.js"></script>
<script src="http://swortain.wang/js/fuse.min.js"></script>
<script src="http://swortain.wang/js/fastsearch.min.js"></script>
<script src="http://swortain.wang/js/search.js"></script>
<script src="http://swortain.wang/js/popper.min.js"></script>
<script src="http://swortain.wang/js/bootstrap.min.js"></script>
<script src="http://swortain.wang/js/jquery.counterup.min.js"></script>
<script src="http://swortain.wang/js/waypoints.min.js"></script>
<script src="http://swortain.wang/js/wow.js"></script>
<script src="http://swortain.wang/js/owl.carousel.min.js"></script>
<script src="http://swortain.wang/js/jquery.slicknav.js"></script>
<script src="http://swortain.wang/js/main.js"></script>

    <script src="http://swortain.wang/js/nivo-lightbox.js"></script>
    <script src="http://swortain.wang/js/form-validator.min.js"></script>
    <script src="http://swortain.wang/js/contact-form-script.min.js"></script>
    <script src="http://swortain.wang/js/summernote.js"></script>

    <div id="preloader">
        <div class="loader" id="loader-1"></div>
    </div>

</body>

</html>